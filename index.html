<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes" />
  <title>Ernesto - Gestion des Cr√©dits</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg: #0f1217;
      --card: rgba(255, 255, 255, 0.04);
      --accent: #3b82f6;
      --accent-dark: #1d4ed8;
      --success: #16a34a;
      --danger: #ef4444;
      --muted: rgba(255, 255, 255, 0.6);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: 'Segoe UI', Inter, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: #fff;
      -webkit-font-smoothing: antialiased;
      padding: 15px;
      font-size: 14px;
    }
    .bubble-bg { position: fixed; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; }
    .bubble {
      position: absolute; bottom: -120px; border-radius: 50%;
      background: rgba(255,255,255,0.04); filter: blur(8px);
      animation: rise linear infinite; animation-fill-mode: both;
    }
    @keyframes rise {
      0% { transform: translateY(0) scale(0.9); opacity: 0; }
      8% { opacity: 0.28; }
      90% { opacity: 0.18; }
      100% { transform: translateY(-140vh) scale(1.15); opacity: 0; }
    }
    .container { max-width: 1400px; margin: 0 auto; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; gap: 10px; flex-wrap: wrap;
    }
    header h1 { margin: 0; font-size: 18px; }
    .modules { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 768px) { .modules { grid-template-columns: 1fr 1fr; } }
    .module { background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    h2 { margin: 0 0 12px; font-size: 16px; font-weight: 700; }
    label { display: block; font-size: 12px; margin-top: 10px; opacity: 0.95; }
    input, select, textarea {
      width: 100%; padding: 8px 10px; margin-top: 4px;
      border-radius: 8px; border: none;
      background: rgba(255,255,255,0.03); color: #fff; font-size: 14px;
    }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .col { flex: 1; min-width: 120px; }
    button {
      padding: 8px 12px; border-radius: 8px; border: none;
      cursor: pointer; font-weight: 600; font-size: 13px;
    }
    .btn-primary { background: var(--accent); color: white; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.06); color: #fff; }
    .btn-danger { background: var(--danger); color: white; }
    .signature-canvas {
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      margin-top: 6px;
      background: #00000010;
      touch-action: none;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 12px; }
    th, td {
      padding: 8px 6px; text-align: left;
      border-bottom: 1px dashed rgba(255,255,255,0.03);
    }
    th { color: #bbb; font-size: 11px; font-weight: 600; }
    .status {
      padding: 4px 6px; border-radius: 4px; font-size: 10px;
      font-weight: 700; display: inline-block;
    }
    .status.ok { background: rgba(22,163,74,0.15); color: var(--success); }
    .status.late { background: rgba(239,68,68,0.15); color: var(--danger); }
    .status.partial { background: rgba(251,191,36,0.15); color: #d97706; }
    .status.paid { background: rgba(255,255,255,0.06); color: #fff; }
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8);
      display: none; z-index: 100; align-items: center; justify-content: center;
      padding: 10px;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: #1a1f29; width: 100%; max-width: 800px; border-radius: 12px;
      padding: 20px; max-height: 90vh; overflow: auto;
    }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 15px; flex-wrap: wrap; gap: 10px;
    }
    .contract { background: white; color: #000; padding: 20px; border-radius: 10px; font-size: 14px; line-height: 1.5; }
    .contract h3 { margin-top: 0; color: #1a365d; font-size: 18px; }
    .signature-box { margin-top: 20px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px; }
    .signature-box div { width: 100%; min-width: 150px; text-align: center; }
    @media (min-width: 480px) { .signature-box div { width: 45%; } }
    .signature-img { height: 50px; border-top: 1px solid #333; padding-top: 6px; }
    .muted { color: var(--muted); font-size: 12px; }
    .pay-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 101; align-items: center; justify-content: center; padding: 10px; }
    .pay-modal.show { display: flex; }
    .pay-content { background: var(--card); padding: 20px; border-radius: 12px; width: 100%; max-width: 400px; }
    .logo-preview { max-width: 150px; max-height: 80px; margin: 8px 0; border-radius: 6px; }
    .contract-page { page-break-after: always; padding: 20px; }
    .contract-page:last-child { page-break-after: avoid; }
    
    /* Styles pour mobile */
    @media (max-width: 480px) {
      body { padding: 10px; }
      .module { padding: 12px; }
      header { flex-direction: column; align-items: flex-start; }
      header h1 { font-size: 16px; }
      .row { flex-direction: column; }
      .col { min-width: auto; }
      button { width: 100%; margin-bottom: 5px; }
      .signature-canvas { width: 100% !important; height: 80px !important; }
      table { font-size: 11px; }
      th, td { padding: 6px 4px; }
    }

    /* Styles pour la signature en plein √©cran */
    .signature-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 20px;
    }
    .signature-modal.show { display: flex; }
    .signature-container {
      background: white;
      border-radius: 10px;
      padding: 20px;
      width: 100%;
      max-width: 500px;
      text-align: center;
    }
    .signature-fullscreen {
      width: 100%;
      height: 200px;
      border: 2px solid #333;
      border-radius: 8px;
      background: white;
      margin: 15px 0;
      touch-action: none;
    }
  </style>
</head>
<body>
  <div class="bubble-bg" aria-hidden="true">
    <div class="bubble" style="left:5%; width:140px; height:140px; animation-duration:28s;"></div>
    <div class="bubble" style="left:22%; width:100px; height:100px; animation-duration:24s; animation-delay:2s;"></div>
    <div class="bubble" style="left:40%; width:160px; height:160px; animation-duration:30s; animation-delay:1s;"></div>
    <div class="bubble" style="left:62%; width:120px; height:120px; animation-duration:26s; animation-delay:3s;"></div>
    <div class="bubble" style="left:82%; width:90px; height:90px; animation-duration:20s; animation-delay:.5s;"></div>
  </div>

  <div class="container">
    <header>
      <div>
        <h1>Ernesto ‚Äî Gestion des Cr√©dits</h1>
        <p class="muted">Donateur : <strong id="adminName">Vladimir Romero Figueroa Ernesto</strong></p>
      </div>
      <div style="display: flex; gap: 6px; flex-wrap: wrap;">
        <button class="btn-ghost" onclick="openSettings()">‚öôÔ∏è Param√®tres</button>
        <button class="btn-ghost" onclick="setupMySignature()">üé® Ma signature</button>
      </div>
    </header>

    <div class="modules">
      <!-- MODULE 1 : CR√âER -->
      <div class="module">
        <h2>üìù Nouveau Cr√©dit</h2>
        <form id="creditForm">
          <label>Pr√©nom *</label>
          <input id="prenom" required>
          <label>Nom *</label>
          <input id="nom" required>
          <label>T√©l√©phone (optionnel)</label>
          <input id="telephone" type="tel">
          <label>Lieu de signature *</label>
          <input id="lieuSignature" required placeholder="Ville, Pays">
          
          <div class="row">
            <div class="col">
              <label>Montant emprunt√© (‚Ç¨) *</label>
              <input id="montant" type="number" step="0.01" min="0.01" required onchange="calculateMonthlyPayment()">
            </div>
            <div class="col">
              <label>Int√©r√™t</label>
              <div style="display:flex; gap:4px;">
                <select id="typeInteret" style="width:40%; padding:8px; border-radius:6px;" onchange="calculateMonthlyPayment()">
                  <option value="%">%</option>
                  <option value="‚Ç¨">‚Ç¨</option>
                </select>
                <input id="interet" type="number" step="0.01" min="0" placeholder="0" onchange="calculateMonthlyPayment()">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Dur√©e du pr√™t (mois) *</label>
              <input id="dureeMois" type="number" min="1" required placeholder="Ex: 12" onchange="calculateMonthlyPayment(); calculateDueDate();">
            </div>
            <div class="col">
              <label>Montant mensuel (‚Ç¨) *</label>
              <input id="montantMensuel" type="number" step="0.01" min="0.01" required placeholder="Ex: 833.33">
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Date de mise √† disposition *</label>
              <input id="dateVersement" type="date" required onchange="calculateDueDate()">
            </div>
            <div class="col">
              <label>Date limite *</label>
              <input id="dateLimite" type="date" required>
            </div>
          </div>
          <label>Note (optionnel)</label>
          <textarea id="note" rows="2"></textarea>
          <label>Signature du d√©biteur *</label>
          <div style="position: relative;">
            <canvas id="debiteurCanvas" class="signature-canvas" width="400" height="100"></canvas>
            <button type="button" class="btn-ghost" onclick="openFullscreenSignature('debiteurCanvas')" style="position: absolute; top: 5px; right: 5px; padding: 4px 8px; font-size: 11px;">üì± Plein √©cran</button>
          </div>
          <div style="display:flex; gap:6px; margin-top:6px; align-items: center;">
            <button type="button" class="btn-ghost" onclick="clearCanvas('debiteurCanvas')">üóëÔ∏è Effacer</button>
            <span class="muted" id="sigStatus">Non sign√©</span>
          </div>
          <div style="margin-top:12px; display:flex; gap:6px; flex-wrap: wrap;">
            <button type="submit" class="btn-primary">‚úÖ Enregistrer</button>
            <button type="button" class="btn-ghost" onclick="resetForm()">üîÑ R√©initialiser</button>
          </div>
        </form>
      </div>

      <!-- MODULE 2 : REGISTRE -->
      <div class="module">
        <h2>üìã Registre des Cr√©dits</h2>
        <div style="overflow:auto; max-height:50vh; margin-top:10px;">
          <table>
            <thead>
              <tr>
                <th>Nom</th>
                <th>Montant</th>
                <th>Reste</th>
                <th>Statut</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="creditsTable"></tbody>
          </table>
        </div>
        <p id="empty" class="muted" style="display:none;">Aucun cr√©dit.</p>
      </div>
    </div>
  </div>

  <!-- MODAL CONTRAT -->
  <div id="contractModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìÑ Contrat de Pr√™t</h2>
        <div style="display: flex; gap: 6px; flex-wrap: wrap;">
          <button class="btn-ghost" onclick="generatePDF()">üìÑ PDF</button>
          <button class="btn-ghost" onclick="printContract()">üñ®Ô∏è Imprimer</button>
          <button class="btn-ghost" onclick="closeContract()">Fermer</button>
        </div>
      </div>
      <div id="contractContent" class="contract"></div>
    </div>
  </div>

  <!-- MODAL PAYER -->
  <div id="payModal" class="pay-modal">
    <div class="pay-content">
      <h3>üí∞ Enregistrer un paiement</h3>
      <p id="payInfo"></p>
      <label>Montant re√ßu (‚Ç¨) *</label>
      <input id="amountReceived" type="number" step="0.01" min="0.01" placeholder="Ex: 10">

      <div style="margin-top:10px;">
        <label>
          <input type="checkbox" id="addInterest"> Ajouter un int√©r√™t (optionnel)
        </label>
        <div id="interestFields" style="display:none; margin-top:6px; display:flex; gap:6px;">
          <select id="interestType" style="width:35%; padding:6px; border-radius:4px;">
            <option value="%">%</option>
            <option value="‚Ç¨">‚Ç¨</option>
          </select>
          <input id="interestValue" type="number" step="0.01" min="0" placeholder="Valeur">
        </div>
      </div>

      <div style="margin-top:15px; display:flex; gap:6px; flex-wrap: wrap;">
        <button class="btn-primary" onclick="confirmPartialPayment()">‚úÖ Enregistrer</button>
        <button class="btn-ghost" onclick="closePayModal()">Annuler</button>
      </div>
    </div>
  </div>

  <!-- MODAL SIGNATURE PLEIN √âCRAN -->
  <div id="fullscreenSigModal" class="signature-modal">
    <div class="signature-container">
      <h3>Signature - Plein √©cran</h3>
      <p>Signez avec votre doigt ou stylet</p>
      <canvas id="fullscreenCanvas" class="signature-fullscreen"></canvas>
      <div style="margin-top:15px; display:flex; gap:8px; justify-content: center;">
        <button class="btn-ghost" onclick="clearFullscreenCanvas()">üóëÔ∏è Effacer</button>
        <button class="btn-primary" onclick="saveFullscreenSignature()">‚úÖ Valider</button>
        <button class="btn-ghost" onclick="closeFullscreenSignature()">‚ùå Annuler</button>
      </div>
    </div>
  </div>

  <!-- CACH√â : CANVAS POUR TA SIGNATURE -->
  <div id="mySigModal" class="modal">
    <div class="modal-content">
      <h3>Signature du pr√™teur (Ernesto)</h3>
      <p>Dessinez une fois. Utilis√©e dans tous les contrats.</p>
      <canvas id="myCanvas" width="400" height="100" style="border:1px solid #555; border-radius:6px; background:#00000010;"></canvas>
      <div style="margin-top:8px; display:flex; gap:6px;">
        <button class="btn-ghost" onclick="clearCanvas('myCanvas')">üóëÔ∏è Effacer</button>
        <button class="btn-primary" onclick="saveMySignature()">‚úÖ Sauvegarder</button>
      </div>
    </div>
  </div>

  <!-- MODAL PARAM√àTRES -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è Param√®tres</h2>
        <button class="btn-ghost" onclick="closeSettings()">Fermer</button>
      </div>
      
      <div style="margin-bottom: 15px;">
        <h3>Logo de l'entreprise</h3>
        <p class="muted">Le logo appara√Ætra sur les contrats imprim√©s</p>
        
        <div id="logoPreviewContainer" style="margin: 10px 0;">
          <img id="logoPreview" class="logo-preview" src="" alt="Aper√ßu du logo" style="display: none;">
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <input type="file" id="logoUpload" accept="image/*" style="display: none;">
          <button type="button" class="btn-primary" onclick="document.getElementById('logoUpload').click()">
            üìÅ Choisir un logo
          </button>
          <button type="button" class="btn-ghost" onclick="removeLogo()" id="removeLogoBtn" style="display: none;">
            üóëÔ∏è Supprimer
          </button>
        </div>
        
        <p class="muted" style="margin-top: 6px; font-size: 11px;">
          Formats accept√©s : JPG, PNG, SVG (max 2MB)
        </p>
      </div>

      <div style="margin-bottom: 15px;">
        <h3>Informations du pr√™teur</h3>
        <label>Nom complet *</label>
        <input type="text" id="lenderName" value="Vladimir Romero Figueroa Ernesto" style="margin-bottom: 8px;">
        
        <label>Adresse</label>
        <textarea id="lenderAddress" rows="2" placeholder="Adresse compl√®te..."></textarea>
        
        <label>T√©l√©phone</label>
        <input type="tel" id="lenderPhone" placeholder="Num√©ro de t√©l√©phone...">
      </div>

      <div style="display: flex; gap: 6px; justify-content: flex-end; flex-wrap: wrap;">
        <button class="btn-primary" onclick="saveSettings()">‚úÖ Sauvegarder</button>
        <button class="btn-ghost" onclick="closeSettings()">Annuler</button>
      </div>
    </div>
  </div>

  <input id="jsonFile" type="file" accept="application/json" style="display:none" />

  <script>
    const DONATEUR = "Vladimir Romero Figueroa Ernesto";
    function uid() { return 'id-' + Math.random().toString(36).slice(2, 10); }
    function todayISO() { return new Date().toISOString().slice(0, 10); }
    function round2(x) { return Math.round((Number(x) + Number.EPSILON) * 100) / 100; }
    function escapeHtml(s) { return s ? String(s).replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '<', '>': '>', '"': '&quot;', "'": '&#39;' }[c])) : ''; }
    function formatEuro(x) { return Number(x || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'EUR' }); }

    const KEY_CREDITS = 'credits_v6';
    const KEY_MY_SIG = 'mySignatureData';
    const KEY_SETTINGS = 'appSettings';
    let debiteurSigned = false;
    let mySigData = localStorage.getItem(KEY_MY_SIG);
    let currentPayId = null;
    let currentContractId = null;
    let currentSignatureCanvas = null;
    let appSettings = JSON.parse(localStorage.getItem(KEY_SETTINGS)) || {};

    function loadCredits() { try { return JSON.parse(localStorage.getItem(KEY_CREDITS)) || []; } catch (e) { return []; } }
    function saveCredits(arr) { localStorage.setItem(KEY_CREDITS, JSON.stringify(arr)); renderTable(); }

    // --- CANVAS AM√âLIOR√â ---
    function initCanvas(id) {
      const canvas = document.getElementById(id);
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.strokeStyle = '#000';
      return { canvas, ctx };
    }

    function setupDrawing(id) {
      const { canvas, ctx } = initCanvas(id);
      let isDown = false;
      let lastX = 0;
      let lastY = 0;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let clientX, clientY;
        
        if (e.type.includes('touch')) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
          e.preventDefault(); // Emp√™che le d√©filement pendant la signature
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }
        
        return {
          x: (clientX - rect.left) * scaleX,
          y: (clientY - rect.top) * scaleY
        };
      };

      const start = (e) => { 
        isDown = true; 
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
        
        if (id === 'debiteurCanvas') {
          debiteurSigned = true;
          document.getElementById('sigStatus').textContent = 'Sign√©';
        }
      };
      
      const draw = (e) => { 
        if (!isDown) return;
        const pos = getPos(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        
        lastX = pos.x;
        lastY = pos.y;
      };
      
      const stop = () => {
        isDown = false;
        ctx.beginPath(); // R√©initialise le chemin pour le prochain trait
      };

      // √âv√©nements souris
      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stop);
      canvas.addEventListener('mouseout', stop);
      
      // √âv√©nements tactiles avec passive: false pour √©viter le d√©filement
      canvas.addEventListener('touchstart', start, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', stop, { passive: false });
      canvas.addEventListener('touchcancel', stop, { passive: false });
    }

    // --- SIGNATURE PLEIN √âCRAN ---
    function openFullscreenSignature(canvasId) {
      currentSignatureCanvas = canvasId;
      const { canvas: originalCanvas } = initCanvas(canvasId);
      const fullscreenCanvas = document.getElementById('fullscreenCanvas');
      
      // Copier le contenu existant
      const ctx = fullscreenCanvas.getContext('2d');
      ctx.drawImage(originalCanvas, 0, 0, fullscreenCanvas.width, fullscreenCanvas.height);
      
      // Configurer le dessin en plein √©cran
      setupFullscreenDrawing();
      document.getElementById('fullscreenSigModal').classList.add('show');
    }

    function setupFullscreenDrawing() {
      const canvas = document.getElementById('fullscreenCanvas');
      const ctx = canvas.getContext('2d');
      let isDown = false;
      let lastX = 0;
      let lastY = 0;

      // Redimensionner le canvas pour qu'il prenne toute la largeur
      canvas.width = canvas.offsetWidth;
      canvas.height = 200;

      const getPos = (e) => {
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;
        
        if (e.type.includes('touch')) {
          clientX = e.touches[0].clientX;
          clientY = e.touches[0].clientY;
          e.preventDefault();
        } else {
          clientX = e.clientX;
          clientY = e.clientY;
        }
        
        return {
          x: clientX - rect.left,
          y: clientY - rect.top
        };
      };

      const start = (e) => { 
        isDown = true; 
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
        ctx.beginPath();
        ctx.moveTo(pos.x, pos.y);
      };
      
      const draw = (e) => { 
        if (!isDown) return;
        const pos = getPos(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        
        lastX = pos.x;
        lastY = pos.y;
      };
      
      const stop = () => {
        isDown = false;
        ctx.beginPath();
      };

      // R√©initialiser les √©v√©nements
      canvas.removeEventListener('mousedown', start);
      canvas.removeEventListener('mousemove', draw);
      canvas.removeEventListener('mouseup', stop);
      canvas.removeEventListener('mouseout', stop);
      canvas.removeEventListener('touchstart', start);
      canvas.removeEventListener('touchmove', draw);
      canvas.removeEventListener('touchend', stop);
      canvas.removeEventListener('touchcancel', stop);

      // R√©appliquer les √©v√©nements
      canvas.addEventListener('mousedown', start);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stop);
      canvas.addEventListener('mouseout', stop);
      canvas.addEventListener('touchstart', start, { passive: false });
      canvas.addEventListener('touchmove', draw, { passive: false });
      canvas.addEventListener('touchend', stop, { passive: false });
      canvas.addEventListener('touchcancel', stop, { passive: false });
    }

    function clearFullscreenCanvas() {
      const canvas = document.getElementById('fullscreenCanvas');
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.strokeStyle = '#000';
      ctx.lineWidth = 3;
    }

    function saveFullscreenSignature() {
      const fullscreenCanvas = document.getElementById('fullscreenCanvas');
      const originalCanvas = document.getElementById(currentSignatureCanvas);
      const originalCtx = originalCanvas.getContext('2d');
      
      // Copier la signature vers le canvas original
      originalCtx.drawImage(fullscreenCanvas, 0, 0, originalCanvas.width, originalCanvas.height);
      
      if (currentSignatureCanvas === 'debiteurCanvas') {
        debiteurSigned = true;
        document.getElementById('sigStatus').textContent = 'Sign√©';
      }
      
      closeFullscreenSignature();
    }

    function closeFullscreenSignature() {
      document.getElementById('fullscreenSigModal').classList.remove('show');
    }

    function clearCanvas(id) {
      const { canvas, ctx } = initCanvas(id);
      if (id === 'debiteurCanvas') {
        debiteurSigned = false;
        document.getElementById('sigStatus').textContent = 'Non sign√©';
      }
    }

    function saveMySignature() {
      mySigData = document.getElementById('myCanvas').toDataURL();
      localStorage.setItem(KEY_MY_SIG, mySigData);
      document.getElementById('mySigModal').classList.remove('show');
      alert('Signature sauvegard√©e.');
    }

    // --- PARAM√àTRES ---
    function openSettings() {
      document.getElementById('lenderName').value = appSettings.lenderName || DONATEUR;
      document.getElementById('lenderAddress').value = appSettings.lenderAddress || '';
      document.getElementById('lenderPhone').value = appSettings.lenderPhone || '';
      
      if (appSettings.logoData) {
        document.getElementById('logoPreview').src = appSettings.logoData;
        document.getElementById('logoPreview').style.display = 'block';
        document.getElementById('removeLogoBtn').style.display = 'block';
      } else {
        document.getElementById('logoPreview').style.display = 'none';
        document.getElementById('removeLogoBtn').style.display = 'none';
      }
      
      document.getElementById('settingsModal').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('show');
    }

    function saveSettings() {
      const lenderName = document.getElementById('lenderName').value.trim();
      if (!lenderName) {
        alert('Le nom du pr√™teur est requis.');
        return;
      }
      
      appSettings = {
        ...appSettings,
        lenderName: lenderName,
        lenderAddress: document.getElementById('lenderAddress').value.trim(),
        lenderPhone: document.getElementById('lenderPhone').value.trim()
      };
      
      localStorage.setItem(KEY_SETTINGS, JSON.stringify(appSettings));
      document.getElementById('adminName').textContent = lenderName;
      closeSettings();
      alert('Param√®tres sauvegard√©s.');
    }

    // Gestion du logo
    document.getElementById('logoUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      if (!file.type.startsWith('image/')) {
        alert('Veuillez s√©lectionner un fichier image.');
        return;
      }
      
      if (file.size > 2 * 1024 * 1024) {
        alert('Le fichier est trop volumineux (max 2MB).');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        appSettings.logoData = e.target.result;
        document.getElementById('logoPreview').src = e.target.result;
        document.getElementById('logoPreview').style.display = 'block';
        document.getElementById('removeLogoBtn').style.display = 'block';
        localStorage.setItem(KEY_SETTINGS, JSON.stringify(appSettings));
      };
      reader.readAsDataURL(file);
    });

    function removeLogo() {
      delete appSettings.logoData;
      document.getElementById('logoPreview').style.display = 'none';
      document.getElementById('removeLogoBtn').style.display = 'none';
      document.getElementById('logoUpload').value = '';
      localStorage.setItem(KEY_SETTINGS, JSON.stringify(appSettings));
    }

    // --- CALCULS AUTOMATIQUES ---
    function calculateMonthlyPayment() {
      const montant = parseFloat(document.getElementById('montant').value) || 0;
      const typeInteret = document.getElementById('typeInteret').value;
      const interet = parseFloat(document.getElementById('interet').value) || 0;
      const dureeMois = parseInt(document.getElementById('dureeMois').value) || 1;

      if (montant > 0 && dureeMois > 0) {
        let totalAmount = montant;
        
        if (typeInteret === '%' && interet > 0) {
          totalAmount = round2(montant * (1 + interet / 100));
        } else if (typeInteret === '‚Ç¨' && interet > 0) {
          totalAmount = round2(montant + interet);
        }
        
        const montantMensuel = round2(totalAmount / dureeMois);
        document.getElementById('montantMensuel').value = montantMensuel.toFixed(2);
      }
    }

    function calculateDueDate() {
      const dateVersement = document.getElementById('dateVersement').value;
      const dureeMois = parseInt(document.getElementById('dureeMois').value) || 1;
      
      if (dateVersement && dureeMois > 0) {
        const date = new Date(dateVersement);
        date.setMonth(date.getMonth() + dureeMois);
        document.getElementById('dateLimite').value = date.toISOString().slice(0, 10);
      }
    }

    // --- CALCUL INITIAL ---
    function calcInitialTotal(credit) {
      return credit.typeInteret === '%' 
        ? round2(credit.montant * (1 + (credit.interet || 0) / 100))
        : round2(credit.montant + (credit.interet || 0));
    }

    function getRemaining(credit) {
      const initial = calcInitialTotal(credit);
      const totalPaid = (credit.payments || []).reduce((sum, p) => sum + p.amount, 0);
      return round2(Math.max(0, initial - totalPaid));
    }

    // --- FORM ---
    let editingId = null;
    document.getElementById('creditForm').addEventListener('submit', e => {
      e.preventDefault();
      if (!debiteurSigned) return alert('Veuillez signer le contrat du d√©biteur.');
      const prenom = document.getElementById('prenom').value.trim();
      const nom = document.getElementById('nom').value.trim();
      const montant = document.getElementById('montant').value;
      const dateLimite = document.getElementById('dateLimite').value;
      const dateVersement = document.getElementById('dateVersement').value;
      const dureeMois = document.getElementById('dureeMois').value;
      const montantMensuel = document.getElementById('montantMensuel').value;
      const lieuSignature = document.getElementById('lieuSignature').value.trim();

      if (!prenom || !nom || !montant || !dateLimite || !dateVersement || !dureeMois || !montantMensuel || !lieuSignature) {
        return alert('Tous les champs marqu√©s * sont requis.');
      }

      const credit = {
        id: editingId || uid(),
        prenom, nom,
        telephone: document.getElementById('telephone').value.trim(),
        montant: Number(montant),
        typeInteret: document.getElementById('typeInteret').value,
        interet: Number(document.getElementById('interet').value) || 0,
        datePret: todayISO(),
        dateLimite,
        dateVersement,
        dureeMois: Number(dureeMois),
        montantMensuel: Number(montantMensuel),
        lieuSignature,
        note: document.getElementById('note').value.trim(),
        debiteurSignature: document.getElementById('debiteurCanvas').toDataURL(),
        payments: [],
        createdAt: editingId ? loadCredits().find(c => c.id === editingId)?.createdAt : new Date().toISOString()
      };

      const credits = loadCredits();
      if (editingId) {
        const idx = credits.findIndex(c => c.id === editingId);
        if (idx !== -1) credits[idx] = credit;
      } else {
        credits.push(credit);
      }
      saveCredits(credits);
      resetForm();
      alert(editingId ? 'Mis √† jour.' : 'Cr√©dit enregistr√©.');
    });

    function resetForm() {
      editingId = null;
      document.getElementById('creditForm').reset();
      clearCanvas('debiteurCanvas');
      document.getElementById('dateVersement').value = todayISO();
      document.getElementById('dateLimite').value = '';
      document.getElementById('montantMensuel').value = '';
    }

    // --- TABLEAU ---
    function renderTable() {
      const tbody = document.getElementById('creditsTable');
      const credits = loadCredits();
      tbody.innerHTML = '';
      document.getElementById('empty').style.display = credits.length ? 'none' : 'block';

      credits.forEach(c => {
        const initial = calcInitialTotal(c);
        const remaining = getRemaining(c);
        let status = 'ok', text = 'EN COURS';
        if (remaining <= 0) { status = 'paid'; text = 'REMBOURS√â'; }
        else if (c.payments && c.payments.length > 0) { status = 'partial'; text = `PARTIEL (${formatEuro(remaining)} restant)`; }
        else if (new Date() > new Date(c.dateLimite)) { status = 'late'; text = 'EN RETARD'; }

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${escapeHtml(c.prenom)}</strong> ${escapeHtml(c.nom)}<div class="muted" style="font-size:11px;">${c.telephone || ''}</div></td>
          <td>${formatEuro(c.montant)}</td>
          <td>${formatEuro(remaining)}</td>
          <td><span class="status ${status}">${text}</span></td>
          <td>
            <button class="btn-ghost" onclick="viewContract('${c.id}')">üëÅÔ∏è Voir</button>
            <button class="btn-ghost" onclick="openPayModal('${c.id}')">üí∞ Payer</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // --- CONTRAT ---
    function viewContract(id) {
      currentContractId = id;
      const credit = loadCredits().find(c => c.id === id);
      if (!credit) return;
      const initial = calcInitialTotal(credit);
      const remaining = getRemaining(credit);

      const firstPaymentDate = new Date(credit.dateVersement);
      firstPaymentDate.setMonth(firstPaymentDate.getMonth() + 1);
      const firstPaymentStr = firstPaymentDate.toISOString().split('T')[0];

      const lenderName = appSettings.lenderName || DONATEUR;

      const content = `
        <!-- PAGE 1 -->
        <div class="contract-page">
          ${appSettings.logoData ? `<div style="text-align: center; margin-bottom: 15px;"><img src="${appSettings.logoData}" style="max-width: 180px; max-height: 70px;"></div>` : ''}
          <h3 style="color: #1a365d; margin-top: 0; text-align: center; font-size: 20px;">CONTRAT DE PR√äT ENTRE PARTICULIERS</h3>
          
          <div style="margin: 20px 0;">
            <p style="font-size: 16px; margin: 12px 0;"><strong>Pr√™teur :</strong> ${lenderName}</p>
            ${appSettings.lenderAddress ? `<p style="font-size: 16px; margin: 12px 0;"><strong>Adresse du pr√™teur :</strong> ${escapeHtml(appSettings.lenderAddress)}</p>` : ''}
            ${appSettings.lenderPhone ? `<p style="font-size: 16px; margin: 12px 0;"><strong>T√©l√©phone du pr√™teur :</strong> ${escapeHtml(appSettings.lenderPhone)}</p>` : ''}
            <p style="font-size: 16px; margin: 12px 0;"><strong>Emprunteur :</strong> ${escapeHtml(credit.prenom)} ${escapeHtml(credit.nom)}</p>
            <p style="font-size: 16px; margin: 12px 0;"><strong>T√©l√©phone emprunteur :</strong> ${credit.telephone || 'Non renseign√©'}</p>
          </div>

          <div style="margin: 20px 0;">
            <h4 style="color: #1a365d; font-size: 18px;">INFORMATIONS DU PR√äT</h4>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Montant du pr√™t :</strong> ${formatEuro(credit.montant)}</p>
            ${credit.interet > 0 ? `<p style="font-size: 15px; margin: 10px 0;"><strong>Int√©r√™t :</strong> ${credit.interet} ${credit.typeInteret}</p>` : ''}
            <p style="font-size: 15px; margin: 10px 0;"><strong>Montant total √† rembourser :</strong> ${formatEuro(initial)}</p>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Dur√©e du pr√™t :</strong> ${credit.dureeMois} mois</p>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Mensualit√© :</strong> ${formatEuro(credit.montantMensuel)}</p>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Date de versement :</strong> ${credit.dateVersement}</p>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Date limite de remboursement :</strong> ${credit.dateLimite}</p>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Premier paiement :</strong> ${firstPaymentStr}</p>
            <p style="font-size: 15px; margin: 10px 0;"><strong>Lieu de signature :</strong> ${escapeHtml(credit.lieuSignature)}</p>
          </div>

          <div style="margin: 20px 0;">
            <h4 style="color: #1a365d; font-size: 18px;">CONDITIONS G√âN√âRALES</h4>
            <p style="font-size: 14px; margin: 8px 0;">1. L'emprunteur s'engage √† rembourser le pr√™t selon l'√©ch√©ancier convenu.</p>
            <p style="font-size: 14px; margin: 8px 0;">2. Tout retard de paiement sup√©rieur √† 15 jours pourra entra√Æner des p√©nalit√©s.</p>
            <p style="font-size: 14px; margin: 8px 0;">3. Le pr√™teur certifie que les fonds proviennent de ressources l√©gales.</p>
            <p style="font-size: 14px; margin: 8px 0;">4. Les deux parties s'engagent √† la confidentialit√© des informations.</p>
          </div>
        </div>

        <!-- PAGE 2 -->
        <div class="contract-page">
          <h4 style="color: #1a365d; font-size: 18px; margin-top: 0;">√âCH√âANCIER DE REMBOURSEMENT</h4>
          <p style="font-size: 15px; margin: 12px 0;">
            L'emprunteur s'engage √† effectuer <strong>${credit.dureeMois} paiements mensuels</strong> 
            de <strong>${formatEuro(credit.montantMensuel)}</strong> chacun, le premier versement 
            √©tant d√ª le <strong>${firstPaymentStr}</strong>.
          </p>

          <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin: 15px 0;">
            <p style="font-size: 15px; margin: 6px 0;"><strong>Total √† rembourser :</strong> ${formatEuro(initial)}</p>
            <p style="font-size: 15px; margin: 6px 0;"><strong>Mensualit√© :</strong> ${formatEuro(credit.montantMensuel)}</p>
            <p style="font-size: 15px; margin: 6px 0;"><strong>Nombre de mensualit√©s :</strong> ${credit.dureeMois}</p>
            <p style="font-size: 15px; margin: 6px 0;"><strong>Date finale :</strong> ${credit.dateLimite}</p>
          </div>

          <h4 style="color: #1a365d; font-size: 18px; margin-top: 25px;">DISPOSITIONS FINALES</h4>
          <p style="font-size: 14px; margin: 10px 0;">En cas de litige, les parties s'engagent √† rechercher une solution amiable avant toute action en justice.</p>
          <p style="font-size: 14px; margin: 10px 0;">Fait √† ${escapeHtml(credit.lieuSignature)}, le ${credit.dateVersement}</p>
          <p style="font-size: 14px; margin: 10px 0;">En deux exemplaires originaux.</p>

          <div style="display: flex; justify-content: space-between; margin-top: 40px; gap: 15px; flex-wrap: wrap;">
            <div style="width: 100%; min-width: 150px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">LE PR√äTEUR</div>
              <div style="margin: 12px 0; height: 70px; display: flex; align-items: center; justify-content: center; border-top: 2px solid #333; padding-top: 10px;">
                ${mySigData ? `<img src="${mySigData}" height="50">` : '<div style="font-size: 13px; color: #666;">Signature manquante</div>'}
              </div>
              <div style="font-size: 15px; font-weight: bold;">${lenderName}</div>
              ${appSettings.lenderAddress ? `<div style="font-size: 13px; color: #555;">${escapeHtml(appSettings.lenderAddress)}</div>` : ''}
            </div>
            <div style="width: 100%; min-width: 150px; text-align: center;">
              <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">L'EMPRUNTEUR</div>
              <div style="margin: 12px 0; height: 70px; display: flex; align-items: center; justify-content: center; border-top: 2px solid #333; padding-top: 10px;">
                ${credit.debiteurSignature && credit.debiteurSignature !== 'data:,' ? `<img src="${credit.debiteurSignature}" height="50">` : '<div style="font-size: 13px; color: #666;">Signature manquante</div>'}
              </div>
              <div style="font-size: 15px; font-weight: bold;">${escapeHtml(credit.prenom)} ${escapeHtml(credit.nom)}</div>
              ${credit.telephone ? `<div style="font-size: 13px; color: #555;">${escapeHtml(credit.telephone)}</div>` : ''}
            </div>
          </div>
        </div>
      `;
      document.getElementById('contractContent').innerHTML = content;
      document.getElementById('contractModal').classList.add('show');
    }

    function closeContract() {
      document.getElementById('contractModal').classList.remove('show');
    }

    function printContract() {
      const credit = loadCredits().find(c => c.id === currentContractId);
      if (!credit) return;
      
      const printWin = window.open('', '_blank');
      printWin.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Contrat de Pr√™t - ${escapeHtml(credit.prenom)} ${escapeHtml(credit.nom)}</title>
          <style>
            body { font-family: Arial, sans-serif; color: #000; padding: 15px; font-size: 16px; line-height: 1.4; }
            .contract-page { page-break-after: always; padding: 20px; }
            .contract-page:last-child { page-break-after: avoid; }
            @media print {
              body { margin: 0; padding: 10px; }
              .contract-page { padding: 15px; }
            }
          </style>
        </head>
        <body>
          ${document.getElementById('contractContent').innerHTML}
        </body>
        </html>
      `);
      printWin.document.close();
      printWin.focus();
      printWin.print();
    }

    // --- G√âN√âRATION PDF ---
    function generatePDF() {
      const credit = loadCredits().find(c => c.id === currentContractId);
      if (!credit) return;
      
      const now = new Date();
      const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '');
      const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '');
      
      const fileName = `credit_${credit.prenom}_${credit.nom}_${dateStr}_${timeStr}.pdf`;
      
      const element = document.getElementById('contractContent');
      const opt = {
        margin: 10,
        filename: fileName,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { 
          scale: 2, 
          useCORS: true,
          logging: false,
          letterRendering: true
        },
        jsPDF: { 
          unit: 'mm', 
          format: 'a4', 
          orientation: 'portrait',
          compress: true
        }
      };
      
      html2pdf().set(opt).from(element).save();
    }

    // --- PAYER ---
    function openPayModal(id) {
      currentPayId = id;
      const credit = loadCredits().find(c => c.id === id);
      const remaining = getRemaining(credit);
      document.getElementById('payInfo').innerText = `Reste √† payer : ${formatEuro(remaining)}`;
      document.getElementById('amountReceived').value = '';
      document.getElementById('addInterest').checked = false;
      document.getElementById('interestFields').style.display = 'none';
      document.getElementById('payModal').classList.add('show');
    }

    document.getElementById('addInterest').addEventListener('change', e => {
      document.getElementById('interestFields').style.display = e.target.checked ? 'flex' : 'none';
    });

    function confirmPartialPayment() {
      const amount = Number(document.getElementById('amountReceived').value);
      if (!amount || amount <= 0) return alert('Montant invalide.');

      const credits = loadCredits();
      const credit = credits.find(c => c.id === currentPayId);
      if (!credit) return;

      let finalAmount = amount;
      if (document.getElementById('addInterest').checked) {
        const type = document.getElementById('interestType').value;
        const val = Number(document.getElementById('interestValue').value);
        if (isNaN(val) || val < 0) return alert('Int√©r√™t invalide.');
        finalAmount = type === '%' ? round2(amount * (1 + val / 100)) : round2(amount + val);
      }

      const payment = {
        amount: finalAmount,
        date: new Date().toISOString(),
        note: document.getElementById('addInterest').checked ? 'Avec int√©r√™t' : 'Paiement partiel'
      };

      credit.payments = credit.payments || [];
      credit.payments.push(payment);

      saveCredits(credits);
      closePayModal();
      alert(`‚úÖ Paiement de ${formatEuro(finalAmount)} enregistr√©.`);
    }

    function closePayModal() {
      document.getElementById('payModal').classList.remove('show');
    }

    // --- INIT ---
    document.getElementById('dateVersement').value = todayISO();
    setupDrawing('debiteurCanvas');
    renderTable();

    if (appSettings.lenderName) {
      document.getElementById('adminName').textContent = appSettings.lenderName;
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeContract(); 
        closePayModal();
        document.getElementById('mySigModal').classList.remove('show');
        document.getElementById('settingsModal').classList.remove('show');
        closeFullscreenSignature();
      }
    });

    function setupMySignature() {
      if (!mySigData) {
        initCanvas('myCanvas');
        setupDrawing('myCanvas');
        document.getElementById('mySigModal').classList.add('show');
      } else {
        alert('Votre signature est d√©j√† enregistr√©e.');
      }
    }
  </script>
</body>
</html>
